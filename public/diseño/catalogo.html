<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Cat√°logo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/estilos/style.css">
</head>

<body>
  <div class="container">
    <p class="txt-1">CAT√ÅLOGO DE CURSOS ONLINE</p>
  </div>

  <!-- Navegaci√≥n com√∫n -->
  <nav>
    <button onclick="location.href='instructores.html'">Instructores</button>
    <button onclick="location.href='iniciarSesion.html'">Iniciar Sesi√≥n</button>
    <button onclick="location.href='crearCuenta.html'">Crear Cuenta</button>
    <button onclick="location.href='catalogo.html'">Mostrar todo</button>
  </nav>

  <!-- Buscar cursos -->
  <form id="formBuscar">
    <center>
      <input type="text" id="buscarInput" class="box" placeholder="Buscar cursos" name="search" required>
      <button type="submit" class="button">Buscar</button>
    </center>
  </form>

  <!-- Bot√≥n para agregar nuevo curso -->
  <div style="text-align: center; margin: 20px;">
    <button class="btn" onclick="agregarCurso()">‚ûï Agregar Curso</button>
  </div>

  <table class="styled-table">
    <thead>
      <tr>
        <th>Cursos</th>
        <th>Categor√≠a</th>
        <th>Instructor</th>
        <th>Precio</th>
        <th>Rating</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaCursos">
      <!-- Cursos cargados din√°micamente -->
    </tbody>
  </table>

  <script>
    const tabla = document.getElementById('tablaCursos');
    const formBuscar = document.getElementById('formBuscar');
    const inputBuscar = document.getElementById('buscarInput');

    let cursos = []; // Guardar todos los cursos

    // Funci√≥n para cargar todos los cursos desde la API
    async function cargarCursos() {
      try {
        const res = await fetch('http://localhost:3000/api/v1/cursos');
        const data = await res.json();
        cursos = Array.isArray(data.data) ? data.data : [];
        renderizarCursos(cursos);
      } catch (error) {
        console.error('Error al cargar cursos:', error);
        tabla.innerHTML = '<tr><td colspan="5">Error al cargar los cursos</td></tr>';
      }
    }

    // Mostrar cursos en la tabla
    function renderizarCursos(lista) {
      if (lista.length === 0) {
        tabla.innerHTML = '<tr><td colspan="5">No se encontraron cursos.</td></tr>';
        return;
      }

      tabla.innerHTML = lista.map(curso => `
  <tr>
    <td>${curso.titulo}</td>
    <td>${curso.categorias?.nombre || 'Sin categor√≠a'}</td>
    <td>${curso.instructores?.usuarios?.nombre || 'Sin instructor'}</td>
    <td>$${curso.precio}</td>
    <td>${curso.instructores?.rating || '-'}</td>
    <td>
      <button class="btn" onclick="editarCurso('${curso.id}')">‚úèÔ∏è Editar</button>
      <button class="btn" onclick="eliminarCurso('${curso.id}')">üóëÔ∏è Eliminar</button>
    </td>
  </tr>
`).join('');
    }

    // Buscar cursos por t√≠tulo
    formBuscar.addEventListener('submit', (e) => {
      e.preventDefault();
      const texto = inputBuscar.value.toLowerCase();
      const filtrados = cursos.filter(curso => curso.titulo.toLowerCase().includes(texto));
      renderizarCursos(filtrados);
    });
 
    //para agregar
    function agregarCurso() {
      window.location.href = "agregarCurso.html";
    }

    // Funci√≥n para editar curso 
    function editarCurso(id) {
      window.location.href = `editarCurso.html?id=${id}`;
    }

    // Funci√≥n para eliminar curso
    async function eliminarCurso(id) {
      if (!confirm("¬øEst√°s seguro de que deseas eliminar este curso?")) return;

      try {
        const res = await fetch(`http://localhost:3000/api/v1/cursos/${id}`, {
          method: 'DELETE'
        });
        const data = await res.json();
        if (res.ok) {
          alert("‚úÖ Curso eliminado.");
          await cargarCursos(); //Vuelve a cargar desde la BD actualizada

        } else {
          alert("‚ùå Error al eliminar: " + data.message);
        }
      } catch (error) {
        console.error("‚ùå Error al eliminar:", error);
        alert("‚ùå Error al eliminar el curso.");
      }
    }

    window.onload = cargarCursos;
  </script>
</body>

</html>